name: Build global user badges

permissions:
  contents: write

on:
  schedule:
    - cron: '0 4 * * *'  # Ejecuta todos los días a las 04:00 UTC
  workflow_dispatch:

jobs:
  build-user-badges:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Instalar GH CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Autenticar GH CLI con PAT
        run: |
          echo "${{ secrets.PAT_TOKEN }}" | gh auth login --with-token

      - name: Obtener métricas globales del usuario
        env:
          GH_USER: Jfernandez27
        run: |
          REPO_COUNT=$(gh api graphql -f query='
            query($login:String!) {
              user(login:$login) {
                repositories(ownerAffiliations:[OWNER], isFork:false) { totalCount }
              }
            }' -f login="$GH_USER" --jq '.data.user.repositories.totalCount')

          COMMIT_COUNT=$(gh api graphql -f query='
            query($login:String!) {
              user(login:$login) {
                contributionsCollection {
                  totalCommitContributions
                }
              }
            }' -f login="$GH_USER" --jq '.data.user.contributionsCollection.totalCommitContributions')

          PR_CONTRIB=$(gh api graphql -f query='
            query($login:String!) {
              user(login:$login) {
                contributionsCollection {
                  totalPullRequestContributions
                }
              }
            }' -f login="$GH_USER" --jq '.data.user.contributionsCollection.totalPullRequestContributions')

          ISSUE_CONTRIB=$(gh api graphql -f query='
            query($login:String!) {
              user(login:$login) {
                contributionsCollection {
                  totalIssueContributions
                }
              }
            }' -f login="$GH_USER" --jq '.data.user.contributionsCollection.totalIssueContributions')

          FOLLOWERS=$(gh api graphql -f query='
            query($login:String!) {
              user(login:$login) {
                followers { totalCount }
              }
            }' -f login="$GH_USER" --jq '.data.user.followers.totalCount')

          STARRED=$(gh api graphql -f query='
            query($login:String!) {
              user(login:$login) {
                starredRepositories { totalCount }
              }
            }' -f login="$GH_USER" --jq '.data.user.starredRepositories.totalCount')

          echo "REPO_COUNT=$REPO_COUNT" >> $GITHUB_ENV
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          echo "PR_CONTRIB=$PR_CONTRIB" >> $GITHUB_ENV
          echo "ISSUE_CONTRIB=$ISSUE_CONTRIB" >> $GITHUB_ENV
          echo "FOLLOWERS=$FOLLOWERS" >> $GITHUB_ENV
          echo "STARRED=$STARRED" >> $GITHUB_ENV

      - name: Generar badges SVG con Shields.io
        run: |
          mkdir -p badges
          curl -s -o badges/public-repos.svg "https://img.shields.io/badge/Repositories-${REPO_COUNT}-0EA5E9?style=flat&labelColor=101010"
          curl -s -o badges/total-commits.svg "https://img.shields.io/badge/Total%20Commits-${COMMIT_COUNT}-10B981?style=flat&labelColor=101010"
          curl -s -o badges/pr-contrib.svg "https://img.shields.io/badge/PR%20Contributions-${PR_CONTRIB}-22C55E?style=flat&labelColor=101010"
          curl -s -o badges/issue-contrib.svg "https://img.shields.io/badge/Issue%20Contributions-${ISSUE_CONTRIB}-DC2626?style=flat&labelColor=101010"
          curl -s -o badges/followers.svg "https://img.shields.io/badge/Followers-${FOLLOWERS}-FACC15?style=flat&labelColor=101010"
          curl -s -o badges/starred.svg "https://img.shields.io/badge/Starred%20Repositories-${STARRED}-F97316?style=flat&labelColor=101010"
          curl -s -o badges/languages.svg "https://img.shields.io/badge/Languages-PHP%20%7C%20Python%20%7C%20JS-D946EF?style=flat&labelColor=101010"

      - name: Commit y push de badges
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'chore: update global user badges'
          file_pattern: 'badges/*.svg'
          token: ${{ secrets.GITHUB_TOKEN }}
